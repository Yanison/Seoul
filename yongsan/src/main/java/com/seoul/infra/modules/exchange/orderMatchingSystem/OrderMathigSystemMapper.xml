<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seoul.infra.modules.exchange.orderMatchingSystem.OrderMathigSystemMapper">

	<resultMap id="Order" type="com.seoul.infra.modules.exchange.orderMatchingSystem.Order">
		<result property ="memberSeq" column="submittedBy"></result>
		<result property ="cryptoSeq" column="submittedCrypto"></result>
	</resultMap>
	<resultMap id="Trade" type="com.seoul.infra.modules.exchange.orderMatchingSystem.Trade"></resultMap>
	

 <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ select OB orders start @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
	<select id="selectBOB" resultMap="Order">
		select
			obSeq
			,submittedBy
			,submittedCrypto
			,format(obAmount,3)
			,price
			,orderType
			,bos
			,orderStatus
			,timestamp
		from orderBook 
			where 1=1
			and bos = 0
			and orderStatus = 0  <!-- orderStatus = 0 :: pending -->
			and submittedCrypto = #{cryptoSeq}
			order by obSeq desc limit 10;
	</select>
	
	<select id="selectBOBOne" resultMap="Order">
		select 
			obSeq
			,submittedBy 
			,submittedCrypto
			,format(obAmount,3)
			,price
			,orderType
			,bos
			,orderStatus
			,timestamp
		from orderBook 
			where 1=1
			and bos = 0
			and orderStatus = 0  <!-- orderStatus = 0 :: pending -->
			and submittedCrypto = #{cryptoSeq}
			order by obSeq desc limit 1;
	</select>
	
	<select id="selectSOB" resultMap="Order">
		select
			obSeq
			,submittedBy
			,submittedCrypto
			,format(obAmount,3)
			,price
			,orderType
			,bos
			,orderStatus
			,timestamp
		from orderBook 
			where 1=1
			and bos = 1
			and orderStatus = 0 <!-- orderStatus = 0 :: pending -->
			and submittedCrypto = #{cryptoSeq}
			order by obSeq limit 10;
	</select>
	
	<select id="selectSOBOne" resultMap="Order">
		select
			obSeq
			,submittedBy
			,submittedCrypto
			,format(obAmount,3)
			,price
			,orderType
			,bos
			,orderStatus
			,timestamp
		from orderBook 
			where 1=1
			and bos = 1
			and orderStatus = 0 <!-- orderStatus = 0 :: pending -->
			and submittedCrypto = #{cryptoSeq}
			<!-- and submittedBy = #{memberSeq} -->
			order by obSeq desc limit 1;
	</select>
	
	
	<select id="selectTransacton" resultMap="Order">
		select * from transaction
		where 1=1
		and cryptoSeq = #{cryptoSeq}
		<if test ="allOrOne == 0">
		order by timestamp desc limit 11;
		</if>
		<if test="allOrOne == 1">
		order by timestamp desc limit 1;
		</if>
	</select>
	
	<select id="marketTable rusultMap" resultMap="Order">
	
		<!-- market table -->   
		select
		
			<!-- column-->  cryptoSeq,
			
			<!--  24시간 고가  -->   
			(select price from transaction where 1=1 and timestamp >= date_add(now(), interval -24 hour) order by timestamp desc limit 1)
			
			<!-- column--> as high24,
			
			<!--  24시간 저가    -->
			(select price from transaction where 1=1 and timestamp >= date_add(now(), interval -24 hour) order by timestamp limit 1)
			
			<!-- column--> as low24,
			
			<!--  일별 거래량    -->
			(select sum(amount) from transaction  where 1=1
			and timestamp >= date_add(now(), interval -24 hour)
			and cryptoSeq = #{cryptoSeq})
			
			<!-- column--> as volume24,
			
			<!--  일별 거래대금    -->
			(select sum(price) from transaction  where 1=1
			and timestamp >= date_add(now(), interval -24 hour)
			and cryptoSeq = #{cryptoSeq})
			
			<!-- column--> as cap24,
			
			<!--  최근 가격   --> 
			(select price from transaction where 1=1 order by timestamp desc limit 1)
			
			<!-- column--> as recentPrice,
			
			<!--  전일 종가    -->
			(select price from transaction where 1=1 
			and  day(timestamp) = ((select day(timestamp) from transaction where 1=1 order by  day(timestamp) desc limit 1)-1) 
			order by timestamp desc limit 1)
			
			<!-- column--> as closingPrice,
			
			<!--  상승 & 하락 비율    -->
			format((
			((select price from transaction where 1=1 
			and  day(timestamp) = ((select day(timestamp) from transaction where 1=1 order by  day(timestamp) desc limit 1)-1) 
			order by timestamp desc limit 1)-(select price from transaction where 1=1 order by timestamp desc limit 1)) 
			/ 
			(select price from transaction where 1=1 
			and  day(timestamp) = ((select day(timestamp) from transaction where 1=1 order by  day(timestamp) desc limit 1)-1) 
			order by timestamp desc limit 1))*100,2)
			
			<!-- column--> as ratio
			
		from transaction 
		where cryptoSeq = #{cryptoSeq} limit 1;
	
	</select>
 <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ select OB orders end @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
 <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ submit orders  start @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
	
	<insert id="submitBids">
		insert into orderBook(
			price
			,format(obAmount,5)
			,submittedBy
			,submittedCrypto
			,orderType
			,bos
			,timestamp
			
		)
		values(
			#{price}
			,#{obAmount}
			,#{memberSeq}
			,#{cryptoSeq}
			,#{orderType}
			,0
			,now()
		)
	</insert>
	
	<insert id="submitAsks">
		insert into orderBook(
			price
			,format(obAmount,5)
			,submittedBy
			,submittedCrypto
			,orderType
			,bos
			,timestamp
			
		)
		values(
			#{price}
			,#{obAmount}
			,#{memberSeq}
			,#{cryptoSeq}
			,#{orderType}
			,1
			,now()
		)
	</insert>
<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ submit orders  end @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
  <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ activate or unactivate Order start @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
 	<update id="delObseq">
 		update orderBook set delNy = 0
			where 1=1
			and obSeq = #{obSeq}
 	</update>
 	
 	<update id="completeOrder">
 		update orderBook set orderStatus = 3
			where 1=1
			and obSeq = #{obSeq}
 	</update>
  <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ activate or unactivate Order end @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
   <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ update order Amount by trading start @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 --> 	
 	<update id="updtObAmount">
 		update orderBook set obAmount = #{obAmount} 
			where 1=1
		 	and obSeq = #{obSeq}
 	</update>
 
 

   <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ update order Amount by trading end @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
 
   <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ insert Transacted Order start @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
 	<insert id="insertTransactions">
 		insert into transaction(
 			memberSeqBuy
			,memberSeqSell
 			,obSeqBuy
 			,obSeqSell
 			,cryptoSeq
 			,timestamp
 			,price
 			,,format(amount,3)
 			,transactedType
 		)
 		values(
 			#{memberSeqBuy}
 			,#{memberSeqSell}
 			,#{obSeqBuy}
 			,#{obSeqSell}
 			,#{cryptoSeq}
 			,now()
 			,#{price}
 			,#{obAmount}
 			,0
 		)
 	</insert>
   <!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ insert Transacted Order end @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
 
 
 
 
</mapper>