<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seoul.infra.modules.exchange.mapper.ExchMapper">
	<resultMap id="Order" type="com.seoul.infra.modules.exchange.orderMatchingSystem.Order">
		<result property ="memberSeq" column="submittedBy"></result>
		<result property ="cryptoSeq" column="submittedCrypto"></result>
	</resultMap>

	<resultMap id="exchDto" type="com.seoul.infra.modules.exchange.dto.ExchDTO"></resultMap>
	<resultMap id="crypto" type="com.seoul.infra.dto.Crypto"></resultMap>
	
	
<!-- 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@ user start
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
	
	<select id="userBalance" resultMap="exchDto">
		select
			m.memberSeq
			,e.cryptoSeq
			,m.idTokenKko
			,e.balance 
		from exchangeBalance e left join member m  
			on e.memberSeq = m.memberSeq
		where 1=1 
		and idTokenKko = #{idTokenKko}
		and cryptoSeq = #{cryptoSeq}
	</select>
	
	<select id="selectUserBalance">
		select balance from exchangeBalance
		where 1=1 
		and memberSeq = #{memberSeq} 
		and cryptoSeq = #{cryptoSeq}
	</select>
	
	<update id="updateUserBalance">
		update exchangeBalance 
			set balance = Round(((select e.balance 
							from (
								select ee.balance 
								from exchangeBalance ee 
								where 1=1 
								and memberSeq = #{memberSeq} 
								and cryptoSeq = #{cryptoSeq} ) e
								) 
						 - #{totalPrice}),1)
	</update>
	
<!-- 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@ user end
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
	
	
	<select id="selectCryptoList" resultMap="crypto">
		select * from crypto 
		where 1=1 
		and cryptoSeq not in('1')
	</select>
	
	<select id="selectCryptoOne" resultMap="exchDto">
		select
			cryptoSeq,
			cryptoSym,
			cryptoName,
			cryptoNameKor
		from crypto
		where 1=1
			and cryptoSym = #{cryptoSym}
	</select>
	
	<select id="getOnlaodInfo"  resultMap="exchDto">
		select
			cryptoSeq
		from crypto
		where cryptoSym = #{cryptoSym}
	</select>
	
	
	
<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ submit orders  start @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
	
	<insert id="submitBids">
		insert into orderBook(
			price
			,obAmount
			,submittedBy
			,submittedCrypto
			,orderType
			,bos
			,timestamp
			
		)
		values(
			#{price}
			,#{obAmount}
			,#{memberSeq}
			,#{cryptoSeq}
			,#{orderType}
			,0
			,now()
		)
	</insert>
	
	<insert id="submitAsks">
		insert into orderBook(
			price
			,obAmount
			,submittedBy
			,submittedCrypto
			,orderType
			,bos
			,timestamp
			
		)
		values(
			#{price}
			,#{obAmount}
			,#{memberSeq}
			,#{cryptoSeq}
			,#{orderType}
			,1
			,now()
		)
	</insert>
<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@ submit orders  end @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 -->
</mapper>